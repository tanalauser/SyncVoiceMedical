<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SyncVoice Medical - Success</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f4f3;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .success-container {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 500px;
        }
        .success-icon {
            font-size: 72px;
            color: #69B578;
            margin-bottom: 20px;
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        p {
            color: #666;
            font-size: 18px;
            line-height: 1.6;
            margin-bottom: 30px;
        }
        .btn {
            display: inline-block;
            padding: 15px 30px;
            background-color: #69B578;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-size: 16px;
            transition: background-color 0.3s;
            margin: 10px;
            border: none;
            cursor: pointer;
        }
        .btn:hover {
            background-color: #5a9d68;
        }
        /* Download button styles */
        .download-btn {
            background-color: #296396;
            font-weight: 600;
        }
        .download-btn:hover {
            background-color: #1e4d73;
        }
        .download-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .paid-info {
            background-color: #e8f5e9;
            padding: 20px;
            border-radius: 5px;
            margin-top: 20px;
        }
        /* Download section styles */
        .download-section {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border: 1px solid #2196F3;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            color: #1565C0;
        }
        .download-section h3 {
            margin-top: 0;
            color: #1565C0;
        }
        .button-group {
            margin-top: 20px;
        }
        .loading {
            opacity: 0.7;
            cursor: not-allowed;
        }
        /* Debug info styles */
        .debug-info {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin-top: 20px;
            font-size: 12px;
            text-align: left;
            display: none;
        }
        .debug-info h4 {
            margin-top: 0;
            color: #666;
        }
        .debug-info pre {
            margin: 5px 0;
            overflow-x: auto;
        }
        /* Manual code entry styles */
        #manualCode {
            padding: 8px 12px;
            margin-right: 10px;
            text-transform: uppercase;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        .validate-btn {
            padding: 8px 15px;
            font-size: 14px;
            background-color: #69B578;
        }
        .validate-btn:hover {
            background-color: #5a9d68;
        }
    </style>
</head>
<body>
    <div class="success-container">
        <div class="success-icon">‚úì</div>
        <h1 id="successTitle">Succ√®s!</h1>
        <p id="successMessage">Veuillez v√©rifier votre email pour le code d'activation.</p>
        
        <!-- Download section for desktop app -->
        <div id="downloadSection" class="download-section" style="display: none;">
            <h3 id="downloadTitle">üì• Votre application desktop est pr√™te!</h3>
            <p id="downloadMessage">Cliquez ci-dessous pour t√©l√©charger l'application SyncVoice Medical pour Windows.</p>
            
            <!-- Add manual code entry option -->
            <div id="manualCodeEntry" style="display: none; margin: 15px 0;">
                <p id="manualCodePrompt" style="margin-bottom: 10px;">Entrez votre code d'activation re√ßu par email:</p>
                <input type="text" id="manualCode" placeholder="Exemple: A1B2C3" style="padding: 8px 12px; margin-right: 10px; text-transform: uppercase; border: 1px solid #ddd; border-radius: 4px; font-size: 16px;">
                <button class="btn validate-btn" onclick="saveManualCode()">Valider</button>
            </div>
            
            <button id="downloadBtn" class="btn download-btn" type="button">
                <span id="downloadBtnText">T√©l√©charger pour Windows</span>
            </button>
            <p><small id="downloadNote">Syst√®me requis: Windows 10 ou sup√©rieur</small></p>
        </div>
        
        <div id="paidInfo" class="paid-info" style="display: none;">
            <p id="paidMessage">Votre paiement a √©t√© effectu√© avec succ√®s. Vous pouvez maintenant acc√©der √† toutes les fonctionnalit√©s.</p>
        </div>
        
        <div class="button-group">
            <a href="index.html" class="btn" id="homeBtn">Retour √† l'accueil</a>
        </div>

        <!-- Debug info section (hidden by default) -->
        <div id="debugInfo" class="debug-info">
            <h4>Debug Information:</h4>
            <pre id="debugContent"></pre>
        </div>
    </div>

    <script>
        // Enable debug mode by adding ?debug=true to URL
        const enableDebug = new URLSearchParams(window.location.search).get('debug') === 'true';
        
        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const lang = urlParams.get('lang') || 'fr';
        const isPaid = urlParams.get('paid') === 'true';
        const hasDownloadIntent = urlParams.get('download') === 'true';
        
        // Get user data from multiple sources (URL, sessionStorage, localStorage)
        let userEmail = urlParams.get('email') || 
                       sessionStorage.getItem('userEmail') || 
                       localStorage.getItem('userEmail');
        
        let activationCode = sessionStorage.getItem('activationCode') || 
                            localStorage.getItem('activationCode');
        
        const userId = urlParams.get('userId') || 
                      sessionStorage.getItem('userId') || 
                      localStorage.getItem('userId');

        // Translations (moved to global scope)
        const translations = {
            fr: {
                title: 'Succ√®s!',
                message: 'Veuillez v√©rifier votre email pour le code d\'activation.',
                paidMessage: 'Votre paiement a √©t√© effectu√© avec succ√®s. Vous pouvez maintenant acc√©der √† toutes les fonctionnalit√©s.',
                homeBtn: 'Retour √† l\'accueil',
                downloadTitle: 'üì• Votre application desktop est pr√™te!',
                downloadMessage: 'Cliquez ci-dessous pour t√©l√©charger l\'application SyncVoice Medical pour Windows.',
                downloadBtnText: 'T√©l√©charger pour Windows',
                downloadNote: 'Syst√®me requis: Windows 10 ou sup√©rieur',
                downloadingText: 'T√©l√©chargement en cours...',
                downloadError: 'Erreur de t√©l√©chargement. Veuillez r√©essayer.',
                missingCredentials: 'Veuillez d\'abord v√©rifier votre email pour obtenir le code d\'activation.',
                checkingCredentials: 'V√©rification des informations...',
                manualCodePrompt: 'Entrez votre code d\'activation re√ßu par email:',
                validateBtn: 'Valider',
                invalidCode: 'Veuillez entrer un code valide (6 caract√®res minimum)'
            },
            en: {
                title: 'Success!',
                message: 'Please check your email for the activation code.',
                paidMessage: 'Your payment was successful. You can now access all features.',
                homeBtn: 'Back to Home',
                downloadTitle: 'üì• Your desktop application is ready!',
                downloadMessage: 'Click below to download the SyncVoice Medical application for Windows.',
                downloadBtnText: 'Download for Windows',
                downloadNote: 'System requirements: Windows 10 or higher',
                downloadingText: 'Downloading...',
                downloadError: 'Download error. Please try again.',
                missingCredentials: 'Please check your email first to get the activation code.',
                checkingCredentials: 'Checking credentials...',
                manualCodePrompt: 'Enter your activation code received by email:',
                validateBtn: 'Validate',
                invalidCode: 'Please enter a valid code (minimum 6 characters)'
            },
            de: {
                title: 'Erfolg!',
                message: 'Bitte √ºberpr√ºfen Sie Ihre E-Mail f√ºr den Aktivierungscode.',
                paidMessage: 'Ihre Zahlung war erfolgreich. Sie k√∂nnen jetzt auf alle Funktionen zugreifen.',
                homeBtn: 'Zur√ºck zur Startseite',
                downloadTitle: 'üì• Ihre Desktop-Anwendung ist bereit!',
                downloadMessage: 'Klicken Sie unten, um die SyncVoice Medical Anwendung f√ºr Windows herunterzuladen.',
                downloadBtnText: 'F√ºr Windows herunterladen',
                downloadNote: 'Systemanforderungen: Windows 10 oder h√∂her',
                downloadingText: 'Wird heruntergeladen...',
                downloadError: 'Download-Fehler. Bitte versuchen Sie es erneut.',
                missingCredentials: 'Bitte √ºberpr√ºfen Sie zuerst Ihre E-Mail, um den Aktivierungscode zu erhalten.',
                checkingCredentials: 'Anmeldeinformationen werden √ºberpr√ºft...',
                manualCodePrompt: 'Geben Sie Ihren per E-Mail erhaltenen Aktivierungscode ein:',
                validateBtn: 'Validieren',
                invalidCode: 'Bitte geben Sie einen g√ºltigen Code ein (mindestens 6 Zeichen)'
            },
            es: {
                title: '¬°√âxito!',
                message: 'Por favor, revise su correo electr√≥nico para el c√≥digo de activaci√≥n.',
                paidMessage: 'Su pago fue exitoso. Ahora puede acceder a todas las funciones.',
                homeBtn: 'Volver al inicio',
                downloadTitle: 'üì• ¬°Su aplicaci√≥n de escritorio est√° lista!',
                downloadMessage: 'Haga clic abajo para descargar la aplicaci√≥n SyncVoice Medical para Windows.',
                downloadBtnText: 'Descargar para Windows',
                downloadNote: 'Requisitos del sistema: Windows 10 o superior',
                downloadingText: 'Descargando...',
                downloadError: 'Error de descarga. Por favor, int√©ntelo de nuevo.',
                missingCredentials: 'Por favor, revise su correo electr√≥nico primero para obtener el c√≥digo de activaci√≥n.',
                checkingCredentials: 'Verificando credenciales...',
                manualCodePrompt: 'Ingrese su c√≥digo de activaci√≥n recibido por correo electr√≥nico:',
                validateBtn: 'Validar',
                invalidCode: 'Por favor ingrese un c√≥digo v√°lido (m√≠nimo 6 caracteres)'
            },
            it: {
                title: 'Successo!',
                message: 'Controlla la tua email per il codice di attivazione.',
                paidMessage: 'Il tuo pagamento √® andato a buon fine. Ora puoi accedere a tutte le funzionalit√†.',
                homeBtn: 'Torna alla home',
                downloadTitle: 'üì• La tua applicazione desktop √® pronta!',
                downloadMessage: 'Clicca qui sotto per scaricare l\'applicazione SyncVoice Medical per Windows.',
                downloadBtnText: 'Scarica per Windows',
                downloadNote: 'Requisiti di sistema: Windows 10 o superiore',
                downloadingText: 'Scaricando...',
                downloadError: 'Errore di download. Riprova.',
                missingCredentials: 'Controlla prima la tua email per ottenere il codice di attivazione.',
                checkingCredentials: 'Verifica delle credenziali...',
                manualCodePrompt: 'Inserisci il tuo codice di attivazione ricevuto via email:',
                validateBtn: 'Valida',
                invalidCode: 'Inserisci un codice valido (minimo 6 caratteri)'
            },
            pt: {
                title: 'Sucesso!',
                message: 'Por favor, verifique seu email para o c√≥digo de ativa√ß√£o.',
                paidMessage: 'Seu pagamento foi bem-sucedido. Agora voc√™ pode acessar todos os recursos.',
                homeBtn: 'Voltar ao in√≠cio',
                downloadTitle: 'üì• Sua aplica√ß√£o desktop est√° pronta!',
                downloadMessage: 'Clique abaixo para baixar a aplica√ß√£o SyncVoice Medical para Windows.',
                downloadBtnText: 'Baixar para Windows',
                downloadNote: 'Requisitos do sistema: Windows 10 ou superior',
                downloadingText: 'Baixando...',
                downloadError: 'Erro de download. Tente novamente.',
                missingCredentials: 'Por favor, verifique seu e-mail primeiro para obter o c√≥digo de ativa√ß√£o.',
                checkingCredentials: 'Verificando credenciais...',
                manualCodePrompt: 'Digite seu c√≥digo de ativa√ß√£o recebido por e-mail:',
                validateBtn: 'Validar',
                invalidCode: 'Por favor, digite um c√≥digo v√°lido (m√≠nimo de 6 caracteres)'
            }
        };

        // Get translations for current language
        const t = translations[lang] || translations.fr;
        
        // Debug logging
        const debugData = {
            timestamp: new Date().toISOString(),
            urlParams: Object.fromEntries(urlParams.entries()),
            lang,
            isPaid,
            hasDownloadIntent,
            userEmail,
            userId,
            activationCode: activationCode ? activationCode.substring(0, 3) + '***' : null,
            sessionStorage: {
                userEmail: sessionStorage.getItem('userEmail'),
                activationCode: sessionStorage.getItem('activationCode') ? 'present' : 'missing',
                userId: sessionStorage.getItem('userId')
            },
            localStorage: {
                userEmail: localStorage.getItem('userEmail'),
                activationCode: localStorage.getItem('activationCode') ? 'present' : 'missing',
                userId: localStorage.getItem('userId')
            }
        };
        
        console.log('Success page loaded with:', debugData);
        
        // Show debug info if enabled
        if (enableDebug) {
            const debugInfoEl = document.getElementById('debugInfo');
            const debugContentEl = document.getElementById('debugContent');
            if (debugInfoEl && debugContentEl) {
                debugInfoEl.style.display = 'block';
                debugContentEl.textContent = JSON.stringify(debugData, null, 2);
            }
        }

        // Function to save manual code (moved to global scope)
        function saveManualCode() {
            const manualCode = document.getElementById('manualCode').value.trim().toUpperCase();
            if (manualCode && manualCode.length >= 6) {
                sessionStorage.setItem('activationCode', manualCode);
                localStorage.setItem('activationCode', manualCode);
                activationCode = manualCode; // Update the global variable
                console.log('Manual code saved:', manualCode);
                
                // Hide the manual entry
                document.getElementById('manualCodeEntry').style.display = 'none';
                
                // Try download again
                if (userEmail) {
                    initiateDownload(userEmail, manualCode);
                }
            } else {
                alert(t.invalidCode);
            }
        }

        // Make saveManualCode globally accessible
        window.saveManualCode = saveManualCode;

        // Apply translations
        document.getElementById('successTitle').textContent = t.title;
        document.getElementById('successMessage').textContent = t.message;
        document.getElementById('paidMessage').textContent = t.paidMessage;
        document.getElementById('homeBtn').textContent = t.homeBtn;
        document.getElementById('homeBtn').href = `index.html?lang=${lang}`;

        // Apply download translations
        document.getElementById('downloadTitle').textContent = t.downloadTitle;
        document.getElementById('downloadMessage').textContent = t.downloadMessage;
        document.getElementById('downloadBtnText').textContent = t.downloadBtnText;
        document.getElementById('downloadNote').textContent = t.downloadNote;
        
        // Apply manual code entry translations
        const manualCodePrompt = document.getElementById('manualCodePrompt');
        if (manualCodePrompt) {
            manualCodePrompt.textContent = t.manualCodePrompt;
        }

        // Show paid info if applicable
        if (isPaid) {
            document.getElementById('paidInfo').style.display = 'block';
        }

        // Show download section if user came from download intent
        if (hasDownloadIntent) {
            console.log('Download intent detected, showing download section');
            document.getElementById('downloadSection').style.display = 'block';
        }

        // Set page language
        document.documentElement.lang = lang;

        // Function to initiate download (moved to global scope)
        function initiateDownload(email, code) {
            const downloadBtn = document.getElementById('downloadBtn');
            const downloadBtnText = document.getElementById('downloadBtnText');
            const originalText = downloadBtnText.textContent;
            
            console.log('Initiating download with:', {
                email: email,
                code: code,
                lang: lang
            });
            
            // Update button state
            downloadBtn.classList.add('loading');
            downloadBtn.disabled = true;
            downloadBtnText.textContent = t.downloadingText;
            
            // Build download URL with credentials
            const downloadUrl = `/api/download-desktop?lang=${lang}&email=${encodeURIComponent(email)}&code=${code}&source=success`;
            
            console.log('Redirecting to:', downloadUrl);
            
            // Redirect to download endpoint
            window.location.href = downloadUrl;
            
            // Reset button after 5 seconds (in case download doesn't redirect)
            setTimeout(() => {
                downloadBtn.classList.remove('loading');
                downloadBtn.disabled = false;
                downloadBtnText.textContent = originalText;
            }, 5000);
        }

        // Handle desktop app download
        const downloadBtn = document.getElementById('downloadBtn');
        if (downloadBtn) {
            downloadBtn.addEventListener('click', async function(e) {
                e.preventDefault();
                
                const downloadBtnText = document.getElementById('downloadBtnText');
                const originalText = downloadBtnText.textContent;
                
                console.log('Download button clicked');
                console.log('Current credentials:', {
                    email: userEmail,
                    activationCode: activationCode ? 'present' : 'missing',
                    userId: userId
                });
                
                // Check if we need to wait for activation code
                if (!activationCode && userEmail) {
                    console.log('No activation code found, showing manual entry...');
                    
                    // Show manual code entry option immediately
                    const manualEntry = document.getElementById('manualCodeEntry');
                    if (manualEntry) {
                        manualEntry.style.display = 'block';
                    }
                    
                    alert(t.missingCredentials);
                    return;
                }
                
                // If we have credentials, proceed with download
                if (!userEmail || !activationCode) {
                    // Show manual code entry option
                    const manualEntry = document.getElementById('manualCodeEntry');
                    if (manualEntry) {
                        manualEntry.style.display = 'block';
                    }
                    
                    alert(t.missingCredentials);
                    console.error('Missing credentials:', { userEmail, activationCode });
                    return;
                }
                
                initiateDownload(userEmail, activationCode);
            });
        }

        // Auto-save email if it comes from URL but isn't in storage
        if (userEmail && urlParams.get('email')) {
            if (!sessionStorage.getItem('userEmail')) {
                sessionStorage.setItem('userEmail', userEmail);
            }
            if (!localStorage.getItem('userEmail')) {
                localStorage.setItem('userEmail', userEmail);
            }
        }

        // Log final state
        console.log('Success page initialization complete');
    </script>
</body>
</html>