<!DOCTYPE html>
<html id="htmlLang" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SyncVoice Medical - Reset Password</title>
    <link rel="stylesheet" href="form.css">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <script src="languageDetection.js"></script>
</head>
<body>
    <div class="container">
        <nav class="nav">
            <a href="index.html" class="logo">
                <img src="SyncVoiceMedicalLogo.png" alt="SyncVoice Medical Logo">
            </a>
            <a href="login.html" id="returnBtn" class="return-btn">Back to Login</a>
        </nav>

        <main class="form-container">
            <h1 id="pageTitle" class="form-title">Reset Password</h1>
            
            <form id="resetForm" class="form">
                <div class="form-group">
                    <label for="newPassword" id="passwordLabel">New Password:</label>
                    <input type="password" id="newPassword" name="newPassword" required minlength="8">
                    <small id="passwordHelp">At least 8 characters</small>
                </div>

                <div class="form-group">
                    <label for="confirmPassword" id="confirmPasswordLabel">Confirm Password:</label>
                    <input type="password" id="confirmPassword" name="confirmPassword" required minlength="8">
                    <div id="passwordMatchMessage" style="margin-top: 5px; font-size: 0.9em;"></div>
                </div>

                <div id="errorMessage" class="error-message" style="display: none;"></div>
                <div id="successMessage" class="success-message" style="display: none; color: #28a745;"></div>

                <button type="submit" id="submitButton" class="submit-btn">Reset Password</button>
            </form>
            
            <div class="form-footer">
                <p>
                    <a href="login.html" id="backToLoginLink">Back to Login</a>
                </p>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Get URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            const email = urlParams.get('email');
            
            // Get language
            let lang;
            if (typeof detectUserLanguage === 'function') {
                lang = detectUserLanguage();
                saveLanguagePreference(lang);
            } else {
                lang = urlParams.get('lang') || localStorage.getItem('selectedLanguage') || 'en';
            }

            // Check if we have required parameters
            if (!token || !email) {
                document.getElementById('errorMessage').textContent = 'Invalid reset link. Please request a new password reset.';
                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById('resetForm').style.display = 'none';
                return;
            }

            // Translations
            const translations = {
                fr: {
                    pageTitle: 'Réinitialiser le mot de passe',
                    passwordLabel: 'Nouveau mot de passe :',
                    confirmPasswordLabel: 'Confirmer le mot de passe :',
                    passwordHelp: 'Au moins 8 caractères',
                    submitButton: 'Réinitialiser le mot de passe',
                    returnButton: 'Retour à la connexion',
                    backToLogin: 'Retour à la connexion',
                    passwordsMatch: 'Les mots de passe correspondent ✓',
                    passwordsDontMatch: 'Les mots de passe ne correspondent pas',
                    passwordTooShort: 'Le mot de passe doit contenir au moins 8 caractères',
                    loading: 'Réinitialisation...',
                    success: 'Mot de passe réinitialisé avec succès ! Redirection vers la page de connexion...',
                    invalidToken: 'Lien de réinitialisation invalide ou expiré.',
                    serverError: 'Erreur du serveur. Veuillez réessayer.'
                },
                en: {
                    pageTitle: 'Reset Password',
                    passwordLabel: 'New Password:',
                    confirmPasswordLabel: 'Confirm Password:',
                    passwordHelp: 'At least 8 characters',
                    submitButton: 'Reset Password',
                    returnButton: 'Back to Login',
                    backToLogin: 'Back to Login',
                    passwordsMatch: 'Passwords match ✓',
                    passwordsDontMatch: 'Passwords do not match',
                    passwordTooShort: 'Password must be at least 8 characters long',
                    loading: 'Resetting...',
                    success: 'Password reset successful! Redirecting to login...',
                    invalidToken: 'Invalid or expired reset link.',
                    serverError: 'Server error. Please try again.'
                },
                de: {
                    pageTitle: 'Passwort zurücksetzen',
                    passwordLabel: 'Neues Passwort:',
                    confirmPasswordLabel: 'Passwort bestätigen:',
                    passwordHelp: 'Mindestens 8 Zeichen',
                    submitButton: 'Passwort zurücksetzen',
                    returnButton: 'Zurück zur Anmeldung',
                    backToLogin: 'Zurück zur Anmeldung',
                    passwordsMatch: 'Passwörter stimmen überein ✓',
                    passwordsDontMatch: 'Passwörter stimmen nicht überein',
                    passwordTooShort: 'Passwort muss mindestens 8 Zeichen lang sein',
                    loading: 'Wird zurückgesetzt...',
                    success: 'Passwort erfolgreich zurückgesetzt! Weiterleitung zur Anmeldung...',
                    invalidToken: 'Ungültiger oder abgelaufener Reset-Link.',
                    serverError: 'Serverfehler. Bitte versuchen Sie es erneut.'
                },
                es: {
                    pageTitle: 'Restablecer contraseña',
                    passwordLabel: 'Nueva contraseña:',
                    confirmPasswordLabel: 'Confirmar contraseña:',
                    passwordHelp: 'Al menos 8 caracteres',
                    submitButton: 'Restablecer contraseña',
                    returnButton: 'Volver al inicio de sesión',
                    backToLogin: 'Volver al inicio de sesión',
                    passwordsMatch: 'Las contraseñas coinciden ✓',
                    passwordsDontMatch: 'Las contraseñas no coinciden',
                    passwordTooShort: 'La contraseña debe tener al menos 8 caracteres',
                    loading: 'Restableciendo...',
                    success: '¡Contraseña restablecida con éxito! Redirigiendo al inicio de sesión...',
                    invalidToken: 'Enlace de restablecimiento inválido o expirado.',
                    serverError: 'Error del servidor. Por favor, inténtelo de nuevo.'
                },
                it: {
                    pageTitle: 'Ripristina password',
                    passwordLabel: 'Nuova password:',
                    confirmPasswordLabel: 'Conferma password:',
                    passwordHelp: 'Almeno 8 caratteri',
                    submitButton: 'Ripristina password',
                    returnButton: 'Torna al login',
                    backToLogin: 'Torna al login',
                    passwordsMatch: 'Le password corrispondono ✓',
                    passwordsDontMatch: 'Le password non corrispondono',
                    passwordTooShort: 'La password deve essere di almeno 8 caratteri',
                    loading: 'Ripristinando...',
                    success: 'Password ripristinata con successo! Reindirizzamento al login...',
                    invalidToken: 'Link di ripristino non valido o scaduto.',
                    serverError: 'Errore del server. Si prega di riprovare.'
                },
                pt: {
                    pageTitle: 'Redefinir senha',
                    passwordLabel: 'Nova senha:',
                    confirmPasswordLabel: 'Confirmar senha:',
                    passwordHelp: 'Pelo menos 8 caracteres',
                    submitButton: 'Redefinir senha',
                    returnButton: 'Voltar ao login',
                    backToLogin: 'Voltar ao login',
                    passwordsMatch: 'As senhas coincidem ✓',
                    passwordsDontMatch: 'As senhas não coincidem',
                    passwordTooShort: 'A senha deve ter pelo menos 8 caracteres',
                    loading: 'Redefinindo...',
                    success: 'Senha redefinida com sucesso! Redirecionando para o login...',
                    invalidToken: 'Link de redefinição inválido ou expirado.',
                    serverError: 'Erro do servidor. Por favor, tente novamente.'
                }
            };

            // Update content based on language
            const t = translations[lang] || translations.en;
            document.getElementById('htmlLang').lang = lang;
            document.getElementById('pageTitle').textContent = t.pageTitle;
            document.getElementById('passwordLabel').textContent = t.passwordLabel;
            document.getElementById('confirmPasswordLabel').textContent = t.confirmPasswordLabel;
            document.getElementById('passwordHelp').textContent = t.passwordHelp;
            document.getElementById('submitButton').textContent = t.submitButton;
            document.getElementById('returnBtn').textContent = t.returnButton;
            document.getElementById('returnBtn').href = `login.html?lang=${lang}`;
            document.getElementById('backToLoginLink').textContent = t.backToLogin;
            document.getElementById('backToLoginLink').href = `login.html?lang=${lang}`;

            // Form elements
            const form = document.getElementById('resetForm');
            const submitButton = document.getElementById('submitButton');
            const errorMessage = document.getElementById('errorMessage');
            const successMessage = document.getElementById('successMessage');
            const newPassword = document.getElementById('newPassword');
            const confirmPassword = document.getElementById('confirmPassword');
            const passwordMatchMessage = document.getElementById('passwordMatchMessage');

            // Password validation
            function validatePasswords() {
                const password = newPassword.value;
                const confirm = confirmPassword.value;
                
                if (password.length < 8) {
                    passwordMatchMessage.textContent = t.passwordTooShort;
                    passwordMatchMessage.style.color = '#dc3545';
                    return false;
                }
                
                if (password && confirm) {
                    if (password === confirm) {
                        passwordMatchMessage.textContent = t.passwordsMatch;
                        passwordMatchMessage.style.color = '#28a745';
                        return true;
                    } else {
                        passwordMatchMessage.textContent = t.passwordsDontMatch;
                        passwordMatchMessage.style.color = '#dc3545';
                        return false;
                    }
                }
                
                passwordMatchMessage.textContent = '';
                return false;
            }

            newPassword.addEventListener('input', validatePasswords);
            confirmPassword.addEventListener('input', validatePasswords);

            // Form submission
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                if (!validatePasswords()) {
                    return;
                }
                
                const originalButtonText = submitButton.textContent;
                submitButton.disabled = true;
                submitButton.textContent = t.loading;
                errorMessage.style.display = 'none';
                successMessage.style.display = 'none';

                try {
                    const response = await fetch('/api/reset-password', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            token,
                            email,
                            newPassword: newPassword.value
                        })
                    });

                    const result = await response.json();

                    if (response.ok && result.success) {
                        successMessage.textContent = t.success;
                        successMessage.style.display = 'block';
                        form.style.display = 'none';
                        
                        // Redirect to login after 3 seconds
                        setTimeout(() => {
                            window.location.href = `login.html?lang=${lang}`;
                        }, 3000);
                    } else {
                        errorMessage.textContent = result.message || t.invalidToken;
                        errorMessage.style.display = 'block';
                    }
                } catch (error) {
                    console.error('Reset password error:', error);
                    errorMessage.textContent = t.serverError;
                    errorMessage.style.display = 'block';
                } finally {
                    submitButton.disabled = false;
                    submitButton.textContent = originalButtonText;
                }
            });
        });
    </script>
</body>
</html>