<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SyncVoice Medical - Payment</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        :root {
            --primary: #0e7c86;
            --primary-dark: #0a5a62;
            --primary-light: #12a3b0;
            --accent: #2ecc71;
            --accent-dark: #27ae60;
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --gray-400: #94a3b8;
            --gray-500: #64748b;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1e293b;
            --white: #ffffff;
            --error: #ef4444;
            --font-display: 'DM Serif Display', serif;
            --font-body: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0,0,0,0.1);
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-body);
            background: linear-gradient(135deg, var(--gray-50) 0%, var(--gray-100) 100%);
            min-height: 100vh;
            color: var(--gray-700);
            line-height: 1.6;
        }

        .header {
            background: var(--white);
            padding: 1rem 2rem;
            box-shadow: var(--shadow-sm);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            text-decoration: none;
            color: var(--gray-800);
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
        }

        .logo-text { font-family: var(--font-display); font-size: 1.25rem; }
        .logo-text span { color: var(--primary); }

        .secure-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--gray-500);
            font-size: 0.875rem;
        }

        .secure-badge svg { color: var(--accent); }

        .main {
            max-width: 500px;
            margin: 0 auto;
            padding: 3rem 1.5rem;
        }

        .payment-card {
            background: var(--white);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            padding: 2.5rem;
            border: 1px solid var(--gray-100);
        }

        .payment-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .payment-title {
            font-family: var(--font-display);
            font-size: 1.75rem;
            color: var(--gray-800);
            margin-bottom: 0.5rem;
        }

        .payment-subtitle {
            color: var(--gray-500);
        }

        .order-summary {
            background: var(--gray-50);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .order-summary h3 {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .order-line {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--gray-200);
        }

        .order-line:last-child { border-bottom: none; }

        .order-line .label { color: var(--gray-600); }

        .order-line .value {
            font-weight: 600;
            color: var(--gray-800);
        }

        .order-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 1rem;
            margin-top: 0.5rem;
            border-top: 2px solid var(--gray-200);
        }

        .order-total .label {
            font-weight: 600;
            color: var(--gray-800);
        }

        .order-total .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .form-group { margin-bottom: 1.5rem; }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
        }

        #payment-element {
            padding: 1rem;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-md);
            background: var(--white);
            transition: border-color 0.2s;
        }

        #payment-element:focus-within {
            border-color: var(--primary);
        }

        .submit-btn {
            width: 100%;
            padding: 1rem 2rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: var(--white);
            border: none;
            border-radius: var(--radius-lg);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
        }

        .submit-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .submit-btn:disabled {
            background: var(--gray-300);
            cursor: not-allowed;
            transform: none;
        }

        .error-message {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: var(--error);
            padding: 1rem;
            border-radius: var(--radius-md);
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
            display: none;
        }

        .error-message.show { display: block; }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--white);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .payment-footer {
            text-align: center;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--gray-100);
        }

        .payment-footer p {
            font-size: 0.8rem;
            color: var(--gray-500);
            margin-bottom: 0.5rem;
        }

        .stripe-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--gray-400);
            font-size: 0.75rem;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--gray-500);
            text-decoration: none;
            font-size: 0.9rem;
            margin-bottom: 1.5rem;
            transition: color 0.2s;
        }

        .back-link:hover { color: var(--primary); }

        .loading-state {
            text-align: center;
            padding: 3rem;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--gray-200);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @media (max-width: 640px) {
            .payment-card { padding: 1.5rem; }
            .header { padding: 1rem; }
        }
    </style>
</head>
<body>
    <header class="header">
        <a href="index.html" class="logo">
            <div class="logo-icon">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>
            </div>
            <span class="logo-text">SyncVoice <span>Medical</span></span>
        </a>
        <div class="secure-badge">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/>
            </svg>
            <span id="secureText">Secure Payment</span>
        </div>
    </header>

    <main class="main">
        <a href="form.html" class="back-link" id="backLink">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
            <span id="backText">Back to registration</span>
        </a>

        <div class="payment-card">
            <div id="loadingState" class="loading-state">
                <div class="loading-spinner"></div>
                <p id="loadingText">Loading payment form...</p>
            </div>

            <div id="paymentContent" style="display: none;">
                <div class="payment-header">
                    <h1 class="payment-title" id="paymentTitle">Complete your payment</h1>
                    <p class="payment-subtitle" id="paymentSubtitle">Enter your payment details below</p>
                </div>

                <div class="order-summary">
                    <h3 id="orderSummaryTitle">Order Summary</h3>
                    <div class="order-line">
                        <span class="label" id="planLabel">Plan</span>
                        <span class="value" id="planValue">Professional</span>
                    </div>
                    <div class="order-line">
                        <span class="label" id="billingLabel">Billing</span>
                        <span class="value" id="billingValue">Monthly</span>
                    </div>
                    <div class="order-total">
                        <span class="label" id="totalLabel">Total</span>
                        <span class="value" id="totalValue">€25.00</span>
                    </div>
                </div>

                <div id="errorMessage" class="error-message"></div>

                <form id="payment-form">
                    <div class="form-group">
                        <label class="form-label" id="cardLabel">Payment method</label>
                        <div id="payment-element"></div>
                    </div>

                    <button type="submit" class="submit-btn" id="submitBtn">
                        <span id="submitText">Pay now</span>
                    </button>
                </form>

                <div class="payment-footer">
                    <p id="securityNote">Your payment is secured with 256-bit SSL encryption</p>
                    <div class="stripe-badge">
                        <svg width="40" height="16" viewBox="0 0 60 25" fill="currentColor">
                            <path d="M59.64 14.28h-8.06c.19 1.93 1.6 2.55 3.2 2.55 1.64 0 2.96-.37 4.05-.95v3.32a10.7 10.7 0 0 1-4.56 1c-4.01 0-6.83-2.5-6.83-7.48 0-4.19 2.39-7.52 6.3-7.52 3.92 0 5.96 3.28 5.96 7.5 0 .4-.02 1.04-.06 1.58zm-8.06-2.62h4.38c0-1.65-.82-2.82-2.19-2.82-1.27 0-2.1 1.11-2.19 2.82zM40.95 20.3c-1.44 0-2.32-.6-2.9-1.04l-.02 4.63-4.12.87V5.57h3.76l.1 1.03a4.35 4.35 0 0 1 3.38-1.35c3.03 0 5.85 2.97 5.85 7.38 0 4.86-2.84 7.67-6.05 7.67zm-.63-11.35c-1.11 0-1.77.43-2.23.96l.02 6.04c.44.5 1.1.92 2.21.92 1.7 0 2.86-1.86 2.86-3.97 0-2.07-1.14-3.95-2.86-3.95zM28.24 5.57h4.13v14.44h-4.13V5.57zm0-5.3L32.37 0v3.36l-4.13.88V.27zM20.08 5.26c.83 0 1.45.1 1.83.22v3.72c-.38-.14-.98-.24-1.75-.24-1.83 0-3.08 1.1-3.08 3.31v7.74h-4.12V5.57h3.74l.2 1.5c.62-1.1 1.84-1.81 3.18-1.81zM5.27 8.03c0-.55.46-1.02 1.3-1.02 1.14 0 2.53.46 3.67 1.24V4.2A10.08 10.08 0 0 0 6.57 3.4C2.64 3.4 0 5.62 0 9.03c0 5.4 7.48 4.53 7.48 6.86 0 .66-.58 1.07-1.52 1.07-1.3 0-2.98-.55-4.3-1.27v4.04A11.28 11.28 0 0 0 5.96 21c4.07 0 6.86-1.97 6.86-5.48.02-5.82-7.55-4.78-7.55-7.49z"/>
                        </svg>
                        <span>Powered by Stripe</span>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Translations
        const translations = {
            en: {
                secureText: 'Secure Payment',
                backText: 'Back to registration',
                paymentTitle: 'Complete your payment',
                paymentSubtitle: 'Enter your payment details below',
                orderSummaryTitle: 'Order Summary',
                planLabel: 'Plan',
                planValue: 'Professional',
                billingLabel: 'Billing',
                billingMonthly: 'Monthly',
                billingYearly: 'Yearly',
                totalLabel: 'Total',
                cardLabel: 'Payment method',
                submitText: 'Pay now',
                processing: 'Processing...',
                securityNote: 'Your payment is secured with 256-bit SSL encryption',
                loadingText: 'Loading payment form...',
                errorGeneric: 'An error occurred. Please try again.',
                successRedirect: 'Payment successful! Redirecting...'
            },
            fr: {
                secureText: 'Paiement sécurisé',
                backText: "Retour à l'inscription",
                paymentTitle: 'Finalisez votre paiement',
                paymentSubtitle: 'Entrez vos informations de paiement ci-dessous',
                orderSummaryTitle: 'Récapitulatif de commande',
                planLabel: 'Formule',
                planValue: 'Professionnel',
                billingLabel: 'Facturation',
                billingMonthly: 'Mensuelle',
                billingYearly: 'Annuelle',
                totalLabel: 'Total',
                cardLabel: 'Moyen de paiement',
                submitText: 'Payer maintenant',
                processing: 'Traitement en cours...',
                securityNote: 'Votre paiement est sécurisé par un chiffrement SSL 256 bits',
                loadingText: 'Chargement du formulaire de paiement...',
                errorGeneric: 'Une erreur est survenue. Veuillez réessayer.',
                successRedirect: 'Paiement réussi ! Redirection...'
            },
            de: {
                secureText: 'Sichere Zahlung',
                backText: 'Zurück zur Registrierung',
                paymentTitle: 'Zahlung abschließen',
                paymentSubtitle: 'Geben Sie unten Ihre Zahlungsdaten ein',
                orderSummaryTitle: 'Bestellübersicht',
                planLabel: 'Plan',
                planValue: 'Professionell',
                billingLabel: 'Abrechnung',
                billingMonthly: 'Monatlich',
                billingYearly: 'Jährlich',
                totalLabel: 'Gesamt',
                cardLabel: 'Zahlungsmethode',
                submitText: 'Jetzt bezahlen',
                processing: 'Verarbeitung...',
                securityNote: 'Ihre Zahlung ist mit 256-Bit-SSL-Verschlüsselung gesichert',
                loadingText: 'Zahlungsformular wird geladen...',
                errorGeneric: 'Ein Fehler ist aufgetreten. Bitte versuchen Sie es erneut.',
                successRedirect: 'Zahlung erfolgreich! Weiterleitung...'
            },
            es: {
                secureText: 'Pago seguro',
                backText: 'Volver al registro',
                paymentTitle: 'Complete su pago',
                paymentSubtitle: 'Ingrese sus datos de pago a continuación',
                orderSummaryTitle: 'Resumen del pedido',
                planLabel: 'Plan',
                planValue: 'Profesional',
                billingLabel: 'Facturación',
                billingMonthly: 'Mensual',
                billingYearly: 'Anual',
                totalLabel: 'Total',
                cardLabel: 'Método de pago',
                submitText: 'Pagar ahora',
                processing: 'Procesando...',
                securityNote: 'Su pago está protegido con encriptación SSL de 256 bits',
                loadingText: 'Cargando formulario de pago...',
                errorGeneric: 'Ha ocurrido un error. Por favor, inténtelo de nuevo.',
                successRedirect: '¡Pago exitoso! Redirigiendo...'
            },
            it: {
                secureText: 'Pagamento sicuro',
                backText: 'Torna alla registrazione',
                paymentTitle: 'Completa il pagamento',
                paymentSubtitle: 'Inserisci i tuoi dati di pagamento qui sotto',
                orderSummaryTitle: "Riepilogo dell'ordine",
                planLabel: 'Piano',
                planValue: 'Professionale',
                billingLabel: 'Fatturazione',
                billingMonthly: 'Mensile',
                billingYearly: 'Annuale',
                totalLabel: 'Totale',
                cardLabel: 'Metodo di pagamento',
                submitText: 'Paga ora',
                processing: 'Elaborazione...',
                securityNote: 'Il tuo pagamento è protetto con crittografia SSL a 256 bit',
                loadingText: 'Caricamento modulo di pagamento...',
                errorGeneric: 'Si è verificato un errore. Per favore riprova.',
                successRedirect: 'Pagamento riuscito! Reindirizzamento...'
            },
            pt: {
                secureText: 'Pagamento seguro',
                backText: 'Voltar ao registro',
                paymentTitle: 'Complete seu pagamento',
                paymentSubtitle: 'Insira seus dados de pagamento abaixo',
                orderSummaryTitle: 'Resumo do pedido',
                planLabel: 'Plano',
                planValue: 'Profissional',
                billingLabel: 'Cobrança',
                billingMonthly: 'Mensal',
                billingYearly: 'Anual',
                totalLabel: 'Total',
                cardLabel: 'Método de pagamento',
                submitText: 'Pagar agora',
                processing: 'Processando...',
                securityNote: 'Seu pagamento é protegido com criptografia SSL de 256 bits',
                loadingText: 'Carregando formulário de pagamento...',
                errorGeneric: 'Ocorreu um erro. Por favor, tente novamente.',
                successRedirect: 'Pagamento bem-sucedido! Redirecionando...'
            }
        };

        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const clientSecret = urlParams.get('clientSecret');
        const lang = urlParams.get('lang') || 'en';
        const billing = urlParams.get('billing') || 'monthly';
        const currency = urlParams.get('currency') || 'EUR';
        const amount = urlParams.get('amount');

        // Get translations
        const t = translations[lang] || translations.en;

        // Update text content
        function updateContent() {
            document.getElementById('secureText').textContent = t.secureText;
            document.getElementById('backText').textContent = t.backText;
            document.getElementById('paymentTitle').textContent = t.paymentTitle;
            document.getElementById('paymentSubtitle').textContent = t.paymentSubtitle;
            document.getElementById('orderSummaryTitle').textContent = t.orderSummaryTitle;
            document.getElementById('planLabel').textContent = t.planLabel;
            document.getElementById('planValue').textContent = t.planValue;
            document.getElementById('billingLabel').textContent = t.billingLabel;
            document.getElementById('billingValue').textContent = billing === 'yearly' ? t.billingYearly : t.billingMonthly;
            document.getElementById('totalLabel').textContent = t.totalLabel;
            document.getElementById('cardLabel').textContent = t.cardLabel;
            document.getElementById('submitText').textContent = t.submitText;
            document.getElementById('securityNote').textContent = t.securityNote;
            document.getElementById('loadingText').textContent = t.loadingText;
            document.getElementById('backLink').href = `form.html?plan=paid&billing=${billing}&lang=${lang}`;

            // Calculate and display total with correct currency position
            const displayAmount = amount ? (parseInt(amount) / 100).toFixed(2) : (billing === 'yearly' ? '250.00' : '25.00');
            
            // GBP uses symbol before amount, EUR uses symbol after for most European languages
            let formattedPrice;
            if (currency === 'GBP') {
                formattedPrice = `£${displayAmount}`;
            } else {
                // European convention: amount followed by € symbol
                formattedPrice = `${displayAmount}€`;
            }
            document.getElementById('totalValue').textContent = formattedPrice;
        }

        updateContent();

        // Initialize Stripe
        let stripe;
        let elements;

        async function initializeStripe() {
            if (!clientSecret) {
                showError('Missing required payment information. Please go back and try again.');
                return;
            }

            try {
                // Get Stripe public key from server
                const response = await fetch('/api/stripe-config');
                const config = await response.json();
                
                if (!config.publishableKey) {
                    throw new Error('Stripe not configured');
                }

                stripe = Stripe(config.publishableKey);

                elements = stripe.elements({
                    clientSecret: clientSecret,
                    appearance: {
                        theme: 'stripe',
                        variables: {
                            colorPrimary: '#0e7c86',
                            colorBackground: '#ffffff',
                            colorText: '#334155',
                            colorDanger: '#ef4444',
                            fontFamily: 'Inter, -apple-system, BlinkMacSystemFont, sans-serif',
                            borderRadius: '8px'
                        }
                    },
                    locale: lang
                });

                const paymentElement = elements.create('payment');
                paymentElement.mount('#payment-element');

                // Show payment form
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('paymentContent').style.display = 'block';

            } catch (error) {
                console.error('Error initializing Stripe:', error);
                showError(t.errorGeneric);
            }
        }

        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.classList.add('show');
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('paymentContent').style.display = 'block';
        }

        // Handle form submission
        document.getElementById('payment-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = `<div class="spinner"></div> ${t.processing}`;

            try {
                const { error, paymentIntent } = await stripe.confirmPayment({
                    elements,
                    confirmParams: {
                        return_url: `${window.location.origin}/success.html?lang=${lang}`,
                    },
                    redirect: 'if_required'
                });

                if (error) {
                    showError(error.message);
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = `<span id="submitText">${t.submitText}</span>`;
                } else if (paymentIntent && paymentIntent.status === 'succeeded') {
                    // Payment succeeded without redirect
                    submitBtn.innerHTML = `<span>✓</span> ${t.successRedirect}`;
                    setTimeout(() => {
                        window.location.href = `/success.html?lang=${lang}`;
                    }, 1500);
                }
            } catch (err) {
                console.error('Payment error:', err);
                showError(t.errorGeneric);
                submitBtn.disabled = false;
                submitBtn.innerHTML = `<span id="submitText">${t.submitText}</span>`;
            }
        });

        // Initialize on page load
        initializeStripe();
    </script>
</body>
</html>
